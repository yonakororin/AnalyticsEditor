# AnalyticsEditor

## 必要な環境

- PHP 7.4以上
- MySQL 8.0以上
- Webサーバー (PHPビルトインサーバー可)

## セットアップ手順

### 1. 構成ファイルの設定

`config` ディレクトリ内の `config.json` を編集し、接続先のデータベース情報を設定してください。

```json
{
    "db": {
        "host": "127.0.0.1",
        "port": 3306,
        "user": "your_username",
        "password": "your_password",
        "database": "mngtools"
    }
}
```

## 2. ビジュアルデータベース構築ツール (AnalyticsEditor)

ブラウザ上で直感的にデータベース操作を行えるツールです。

### 起動方法

PHPのビルトインサーバーを使用して起動します。

```bash
php -S localhost:8080
```

ブラウザで `http://localhost:8080/` にアクセスしてください。

### 使い方

1. **Date Source ノードの追加**
   - 左サイドバーの "Add Date Source" をクリックします。
   - 表示されたノードで、データを抽出したい日付を選択します（複数選択可）。
   - "Create Table" をクリックすると、選択した日付のアクティブユーザーを含む一時テーブルが作成されます。

2. **SQL Query ノードの追加**
   - "Add SQL Query" をクリックします。
   - Date Source ノードの出力ソケット（●）をドラッグして、Query ノードの入力ソケットに接続します。
   - クエリ入力欄に SQL を記述します。 `{input}` は接続元のテーブル名に自動置換されます。
     - 例: `SELECT * FROM {input} LIMIT 10`
   - "Run Query" をクリックして実行します。

3. **その他のデータソースノード**
   - **Table Source**: データベース内の既存テーブルを選択してソースとして利用できます。
   - **File Source**: サーバー上のファイル（CSV, TSV等）を選択し、一時テーブルとしてインポートして利用できます。

4. **SQL Query ノードの機能**
   - **クエリチェーン**: ある Query ノードの出力を別の Query ノードの入力につなげることで、処理を連鎖させることができます（結果は一時テーブルとして保存されます）。
   - **JOIN (複数入力)**: Query ノードには複数の入力ソケットを追加できます。
     - 「+ Input」ボタンで追加された入力は `{input2}`, `{input3}`... としてクエリ内で参照可能です。
     - 例: `SELECT * FROM {input} AS A JOIN {input2} AS B ON A.id = B.id`
   - **SQL プレビュー**: 実行される実際の SQL（マクロ置換後）がノード内にプレビュー表示されます。
   - **オートコンプリート**: テーブル名やSQLキーワードの入力補完が利用可能です。

5. **Filtering Node (Filtering / Join) の追加**
   - 複数の入力を結合（JOIN）したり、フィルタリングするための専用ノードです。
   - GUI上で結合条件（LEFT/INNER JOINなど）や結合キーを指定できます。
   - SQLを書かずに直感的にテーブル結合を行いたい場合に便利です。

6. **Results View ノードの追加**
   - "Add Results View" をクリックします。
   - Query ノードの出力をこのノードに接続します。
   - ページネーション機能付きで結果を確認できます。

7. **エッジ（接続線）の操作**
   - **選択**: 線をクリックするとオレンジ色にハイライトされます。
   - **削除**: 線をダブルクリックするか、選択状態で `Delete` または `Backspace` キーを押すと削除できます。

8. **DB Browser (データベースブラウザ)**
   - サイドバーの "DB Browser" から利用できます。
   - データベース内のテーブル一覧、行数、作成日時などを確認できます。
   - テーブルを選択してスキーマ定義（CREATE TABLE文）を表示したり、不要なテーブルを一括削除することができます。

9. **キャッシュの削除**
   - ツールは動作のために `webapp_cache_` で始まる一時テーブルを作成します。
   - サイドバーの "Cleanup Cache" ボタンを押すことで、これらの一時テーブルを一括削除できます。

10. **グラフの保存と読み込み**
   - **Save Graph**: 現在のグラフ構成（ノード配置、クエリ内容、パス設定など）をサーバー上の JSON ファイルとして保存します。
   - **Load Graph**: 保存された JSON ファイルを選択して、グラフ構成を復元します。

11. **結果のエクスポート**
   - Results View ノードにて、出力先フォルダとファイル名を指定し、CSV形式で結果を保存できます。

### CLI 実行 (バッチ処理)

保存したグラフファイルは、コマンドラインから実行することができます。これにより、作成したワークフローをcron等で定期実行することが可能です。

```bash
php cli.php <グラフファイルへのパス> [options]

# 例: 基本実行
php cli.php saved_graphs/daily_report.json
```

#### オプション

実行時にファイルパスや変数を動的に上書きできます。

| オプション | 説明 | 例 |
| :--- | :--- | :--- |
| `--file=<path>[,<path>...]` | `FileNode` で読み込むファイルを上書きします。カンマ区切りで複数指定した場合、１つのテーブルにマージされます（ヘッダーは最初のファイルに準拠）。 | `--file="f1.csv,f2.csv"` |
| `--table=<name>` | `TableNode` で読み込むテーブルを上書きします | `--table=users_2025` |
| `--db=<name>` | `TableNode` で読み込むデータベースを上書きします | `--db=production` |
| `--var-<name>=<val>` | `QueryNode` 内の `{name}` 変数を置換します | `--var-target_date="2025-01-01"` |

#### クエリ内変数の利用例

Query ノードの SQL に変数を埋め込んでおき、実行時に値を渡すことができます。

**SQL:**
```sql
SELECT * FROM {input} WHERE created_at >= '{target_date}'
```

**実行コマンド:**
```bash
php cli.php graph.json --var-target_date="2024-01-01"
```



